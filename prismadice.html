<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PRISMADICe</title>
<link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root {
  --red: #E63946;
  --yellow: #F4D35E;
  --green: #2A9D8F;
  --blue: #457B9D;
  --purple: #7B2D8E;
  --rainbow-white: #F1FAEE;
  --bg-dark: #1A1A2E;
  --bg-card: #16213E;
  --bg-surface: #0F3460;
  --text-primary: #F1FAEE;
  --text-secondary: #A8DADC;
  --text-muted: #6B7FA3;
  --accent: #E63946;
  --gold: #F4D35E;
  --success: #2A9D8F;
  --locked-glow: rgba(244, 211, 94, 0.4);
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: 'Fredoka', sans-serif;
  background: var(--bg-dark);
  color: var(--text-primary);
  min-height: 100vh;
  overflow-x: hidden;
}

.bg-pattern {
  position: fixed;
  inset: 0;
  background:
    radial-gradient(ellipse at 20% 50%, rgba(230,57,70,0.08) 0%, transparent 50%),
    radial-gradient(ellipse at 80% 20%, rgba(69,123,157,0.08) 0%, transparent 50%),
    radial-gradient(ellipse at 50% 80%, rgba(123,45,142,0.08) 0%, transparent 50%);
  pointer-events: none;
  z-index: 0;
}

.hidden { display: none !important; }

.screen { display: none; position: relative; z-index: 1; }
.screen.active { display: flex; }

/* ========== PASSWORD SCREEN ========== */
#password-screen {
  min-height: 100vh;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  gap: 24px;
}

.logo-title {
  font-size: 3.5rem;
  font-weight: 700;
  letter-spacing: 2px;
  background: linear-gradient(135deg, var(--red), var(--yellow), var(--green), var(--blue), var(--purple));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  text-align: center;
  filter: drop-shadow(0 4px 12px rgba(0,0,0,0.3));
}

.logo-subtitle {
  color: var(--text-secondary);
  font-size: 1rem;
  margin-top: -12px;
  letter-spacing: 4px;
  text-transform: uppercase;
}

.input-group {
  display: flex;
  flex-direction: column;
  gap: 8px;
  width: 320px;
  max-width: 90vw;
}

.input-group label {
  font-size: 0.85rem;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 2px;
}

input[type="text"], input[type="password"] {
  font-family: 'JetBrains Mono', monospace;
  font-size: 1rem;
  padding: 12px 16px;
  background: var(--bg-card);
  border: 2px solid var(--bg-surface);
  border-radius: 10px;
  color: var(--text-primary);
  outline: none;
  transition: border-color 0.2s;
  width: 100%;
}

input:focus { border-color: var(--blue); }

.btn {
  font-family: 'Fredoka', sans-serif;
  font-size: 1rem;
  font-weight: 600;
  padding: 12px 32px;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  transition: all 0.2s;
  letter-spacing: 1px;
}

.btn-primary {
  background: linear-gradient(135deg, var(--blue), var(--purple));
  color: white;
}
.btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(69,123,157,0.4); }
.btn-primary:disabled { opacity: 0.4; cursor: not-allowed; transform: none; box-shadow: none; }

.btn-accent {
  background: linear-gradient(135deg, var(--red), #c62828);
  color: white;
}
.btn-accent:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(230,57,70,0.4); }

.btn-success {
  background: linear-gradient(135deg, var(--green), #1a7a6d);
  color: white;
}
.btn-success:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(42,157,143,0.4); }
.btn-success:disabled { opacity: 0.4; cursor: not-allowed; transform: none; box-shadow: none; }

.btn-cancel {
  background: var(--bg-surface);
  color: var(--text-secondary);
}

.btn-sm { padding: 8px 20px; font-size: 0.85rem; }

.error-msg {
  color: var(--red);
  font-size: 0.85rem;
  min-height: 20px;
}

/* ========== LOBBY SCREEN ========== */
#lobby-screen {
  min-height: 100vh;
  flex-direction: column;
  align-items: center;
  padding: 40px 20px;
  gap: 24px;
}

.lobby-card {
  background: var(--bg-card);
  border: 1px solid var(--bg-surface);
  border-radius: 16px;
  padding: 32px;
  width: 480px;
  max-width: 95vw;
}

.lobby-card h2 {
  font-size: 1.3rem;
  margin-bottom: 20px;
  color: var(--text-secondary);
}

.player-slots {
  display: flex;
  flex-direction: column;
  gap: 10px;
  margin-bottom: 24px;
}

.player-slot {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 10px 16px;
  background: var(--bg-dark);
  border-radius: 10px;
  border: 2px solid var(--bg-surface);
  min-height: 48px;
}

.player-slot.occupied {
  border-color: var(--green);
  background: rgba(42, 157, 143, 0.08);
}

.player-slot.you {
  border-color: var(--gold);
  background: rgba(244, 211, 94, 0.08);
}

.slot-number {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.75rem;
  color: var(--text-muted);
  width: 20px;
  text-align: center;
}

.slot-name { flex: 1; font-weight: 500; }

.slot-empty {
  color: var(--text-muted);
  font-style: italic;
  font-size: 0.85rem;
}

.slot-you-badge {
  font-size: 0.7rem;
  background: var(--gold);
  color: var(--bg-dark);
  padding: 2px 8px;
  border-radius: 6px;
  font-weight: 600;
}

.join-form {
  display: flex;
  gap: 10px;
  align-items: flex-end;
}

.join-form .input-group { flex: 1; }

.lobby-status {
  text-align: center;
  color: var(--text-muted);
  font-size: 0.9rem;
}

/* ========== GAME SCREEN ========== */
#game-screen {
  min-height: 100vh;
  flex-direction: column;
}

.game-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 24px;
  background: var(--bg-card);
  border-bottom: 1px solid var(--bg-surface);
}

.game-header .logo-title { font-size: 1.5rem; }

.abandon-btn {
  font-family: 'Fredoka', sans-serif;
  font-size: 0.75rem;
  font-weight: 500;
  padding: 6px 14px;
  background: transparent;
  border: 1px solid var(--red);
  border-radius: 8px;
  color: var(--red);
  cursor: pointer;
  transition: all 0.2s;
  letter-spacing: 1px;
  text-transform: uppercase;
}

.abandon-btn:hover {
  background: var(--red);
  color: white;
}

.round-info {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.85rem;
  color: var(--text-secondary);
}

.turn-banner {
  text-align: center;
  padding: 10px;
  font-weight: 600;
  font-size: 1.1rem;
  background: rgba(69,123,157,0.15);
  border-bottom: 1px solid var(--bg-surface);
}

.turn-banner.your-turn {
  background: rgba(244,211,94,0.15);
  color: var(--gold);
}

.game-layout {
  display: flex;
  flex: 1;
  overflow: hidden;
}

.player-sidebar {
  width: 200px;
  min-width: 200px;
  background: var(--bg-card);
  border-right: 1px solid var(--bg-surface);
  padding: 16px;
  overflow-y: auto;
}

.sidebar-title {
  font-size: 0.75rem;
  text-transform: uppercase;
  letter-spacing: 2px;
  color: var(--text-muted);
  margin-bottom: 12px;
}

.sidebar-player {
  padding: 10px 12px;
  border-radius: 8px;
  margin-bottom: 6px;
  cursor: pointer;
  transition: all 0.15s;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.sidebar-player:hover { background: var(--bg-surface); }
.sidebar-player.active-turn {
  background: rgba(69,123,157,0.2);
  border-left: 3px solid var(--blue);
}
.sidebar-player.viewing {
  background: rgba(244,211,94,0.1);
  outline: 1px solid var(--gold);
}

.sidebar-player-name { font-size: 0.9rem; font-weight: 500; }
.sidebar-player-score {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.8rem;
  color: var(--text-muted);
}

.game-main {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow-y: auto;
  padding: 20px;
  gap: 20px;
}

/* Dice */
.dice-section {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 16px;
}

.dice-row {
  display: flex;
  gap: 14px;
  flex-wrap: wrap;
  justify-content: center;
}

.die-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 6px;
}

.die {
  width: 64px;
  height: 64px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: 'JetBrains Mono', monospace;
  font-size: 1.8rem;
  font-weight: 700;
  cursor: default;
  transition: all 0.2s;
  position: relative;
  border: 3px solid transparent;
}

.die.red { background: var(--red); color: white; }
.die.yellow { background: var(--yellow); color: var(--bg-dark); }
.die.green { background: var(--green); color: white; }
.die.blue { background: var(--blue); color: white; }
.die.purple { background: var(--purple); color: white; }
.die.rainbow {
  background: linear-gradient(135deg, #fff 0%, #f0f0f0 100%);
  color: var(--bg-dark);
  font-size: 1.2rem;
}

.die.clickable { cursor: pointer; }
.die.clickable:hover { transform: translateY(-4px); }

.die.locked {
  border-color: var(--gold);
  box-shadow: 0 0 16px var(--locked-glow);
}

.die.locked::after {
  content: 'ðŸ”’';
  position: absolute;
  top: -8px;
  right: -8px;
  font-size: 0.7rem;
}

.die-label {
  font-size: 0.65rem;
  text-transform: uppercase;
  letter-spacing: 2px;
  color: var(--text-muted);
}

.die.rolling { animation: dieRoll 0.4s ease-in-out; }

@keyframes dieRoll {
  0% { transform: rotateX(0) scale(1); }
  25% { transform: rotateX(90deg) scale(0.8); }
  50% { transform: rotateX(180deg) scale(0.9); }
  75% { transform: rotateX(270deg) scale(0.8); }
  100% { transform: rotateX(360deg) scale(1); }
}

.roll-controls {
  display: flex;
  gap: 12px;
  align-items: center;
}

.roll-count {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.85rem;
  color: var(--text-muted);
}

/* Scoring */
.scoring-section {
  display: flex;
  gap: 20px;
  flex-wrap: wrap;
  justify-content: center;
}

.score-panel {
  background: var(--bg-card);
  border: 1px solid var(--bg-surface);
  border-radius: 12px;
  padding: 16px;
  min-width: 280px;
  flex: 1;
  max-width: 400px;
}

.score-panel h3 {
  font-size: 0.85rem;
  text-transform: uppercase;
  letter-spacing: 2px;
  color: var(--text-secondary);
  margin-bottom: 12px;
  padding-bottom: 8px;
  border-bottom: 1px solid var(--bg-surface);
}

.score-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 6px 10px;
  border-radius: 6px;
  transition: all 0.15s;
  gap: 8px;
}

.score-row:nth-child(even) { background: rgba(255,255,255,0.02); }
.score-row.clickable { cursor: pointer; }
.score-row.clickable:hover { background: rgba(69,123,157,0.15); }
.score-row.used { opacity: 0.5; }
.score-row.selected {
  background: rgba(42,157,143,0.2);
  outline: 1px solid var(--green);
}

.score-category { font-size: 0.85rem; flex: 1; }
.score-value {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.85rem;
  min-width: 36px;
  text-align: right;
}

.score-value.potential { color: var(--gold); }
.score-value.scored { color: var(--text-muted); }
.score-value.zero { color: var(--red); opacity: 0.6; }

.score-bonus-row {
  border-top: 1px solid var(--bg-surface);
  margin-top: 8px;
  padding-top: 8px;
  font-weight: 600;
}

/* Color chart */
.color-chart-panel {
  background: var(--bg-card);
  border: 1px solid var(--bg-surface);
  border-radius: 12px;
  padding: 16px;
  width: 100%;
  max-width: 500px;
}

.color-chart-panel h3 {
  font-size: 0.85rem;
  text-transform: uppercase;
  letter-spacing: 2px;
  color: var(--text-secondary);
  margin-bottom: 12px;
  padding-bottom: 8px;
  border-bottom: 1px solid var(--bg-surface);
}

.color-chart {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.chart-header-row {
  display: flex;
  gap: 6px;
  padding-left: 72px;
}

.chart-header-cell {
  width: 48px;
  text-align: center;
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.75rem;
  color: var(--text-muted);
}

.chart-row {
  display: flex;
  align-items: center;
  gap: 6px;
}

.chart-row-label {
  width: 66px;
  font-size: 0.75rem;
  text-transform: uppercase;
  letter-spacing: 1px;
  text-align: right;
  padding-right: 6px;
}

.chart-cell {
  width: 48px;
  height: 48px;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.9rem;
  font-weight: 600;
  transition: all 0.15s;
  border: 2px solid transparent;
}

.chart-cell.empty {
  background: var(--bg-dark);
  border-color: var(--bg-surface);
}

.chart-cell.crossed {
  background: rgba(255,255,255,0.1);
  position: relative;
}

.chart-cell.crossed::after {
  content: 'âœ•';
  font-size: 1.4rem;
  color: var(--text-primary);
}

.chart-cell.clickable {
  cursor: pointer;
  border-color: var(--gold);
  animation: cellPulse 1.5s ease-in-out infinite;
}

.chart-cell.selected-cross {
  border-color: var(--green);
  background: rgba(42,157,143,0.2);
}

.chart-cell.selected-cross::after {
  content: 'âœ•';
  font-size: 1.4rem;
  color: var(--green);
}

@keyframes cellPulse {
  0%, 100% { box-shadow: 0 0 0 0 rgba(244,211,94,0.3); }
  50% { box-shadow: 0 0 12px 2px rgba(244,211,94,0.3); }
}

.chart-row-score {
  width: 40px;
  text-align: center;
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.8rem;
  color: var(--text-muted);
}

.chart-column-scores {
  display: flex;
  gap: 6px;
  padding-left: 72px;
  margin-top: 4px;
}

.chart-col-score {
  width: 48px;
  text-align: center;
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.8rem;
  color: var(--text-muted);
}

.rainbow-info {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  padding: 8px 16px;
  background: rgba(244,211,94,0.1);
  border-radius: 8px;
  margin-bottom: 12px;
  font-size: 0.85rem;
  color: var(--gold);
}

.turn-actions {
  display: flex;
  gap: 12px;
  justify-content: center;
  flex-wrap: wrap;
}

/* Phase indicator */
.phase-indicator {
  display: flex;
  gap: 4px;
  align-items: center;
  justify-content: center;
  margin: 8px 0;
}

.phase-step {
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 0.75rem;
  text-transform: uppercase;
  letter-spacing: 1px;
  background: var(--bg-surface);
  color: var(--text-muted);
}

.phase-step.active { background: var(--blue); color: white; }
.phase-step.completed { background: var(--green); color: white; }
.phase-arrow { color: var(--text-muted); font-size: 0.7rem; }

/* Overlays */
.overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.8);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 100;
}

.overlay.visible { display: flex; }

.overlay-card {
  background: var(--bg-card);
  border-radius: 16px;
  padding: 40px;
  text-align: center;
  max-width: 500px;
  width: 90vw;
}

.overlay-card.abandon { border: 2px solid var(--red); max-width: 400px; padding: 32px; }
.overlay-card.gameover { border: 2px solid var(--gold); }

.overlay-card h2 {
  font-size: 2rem;
  background: linear-gradient(135deg, var(--gold), var(--red));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  margin-bottom: 24px;
}

.overlay-card h3 { color: var(--red); margin-bottom: 12px; }
.overlay-card p { color: var(--text-secondary); margin-bottom: 24px; font-size: 0.9rem; }

.confirm-buttons {
  display: flex;
  gap: 12px;
  justify-content: center;
}

.final-scores {
  display: flex;
  flex-direction: column;
  gap: 8px;
  margin-bottom: 24px;
}

.final-score-row {
  display: flex;
  justify-content: space-between;
  padding: 8px 16px;
  background: var(--bg-dark);
  border-radius: 8px;
}

.final-score-row.winner {
  background: rgba(244,211,94,0.15);
  border: 1px solid var(--gold);
}

.final-score-name { font-weight: 600; }
.final-score-pts {
  font-family: 'JetBrains Mono', monospace;
  font-weight: 600;
}

.fade-in { animation: fadeIn 0.3s ease-out; }

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

@media (max-width: 768px) {
  .logo-title { font-size: 2.2rem; }
  .game-layout { flex-direction: column; }
  .player-sidebar {
    width: 100%;
    min-width: unset;
    flex-direction: row;
    display: flex;
    gap: 8px;
    overflow-x: auto;
    padding: 10px;
    border-right: none;
    border-bottom: 1px solid var(--bg-surface);
  }
  .sidebar-title { display: none; }
  .sidebar-player { white-space: nowrap; margin-bottom: 0; }
  .scoring-section { flex-direction: column; align-items: center; }
  .die { width: 52px; height: 52px; font-size: 1.5rem; }
  .chart-cell { width: 40px; height: 40px; }
  .chart-header-row, .chart-column-scores { padding-left: 60px; }
  .chart-row-label { width: 54px; font-size: 0.65rem; }
}
</style>
</head>
<body>

<div class="bg-pattern"></div>

<!-- PASSWORD SCREEN -->
<div id="password-screen" class="screen active">
  <div class="logo-title">PRISMADICe</div>
  <div class="logo-subtitle">by Markee Games</div>
  <div class="input-group">
    <label>Enter Password</label>
    <input type="password" id="password-input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="off">
  </div>
  <div class="error-msg" id="password-error"></div>
  <button class="btn btn-primary" onclick="checkPassword()">Enter</button>
</div>

<!-- LOBBY SCREEN -->
<div id="lobby-screen" class="screen">
  <div class="logo-title" style="font-size:2.2rem;">PRISMADICe</div>
  <div class="lobby-card">
    <h2>Game Lobby</h2>
    <div class="player-slots" id="player-slots"></div>
    <div id="join-section">
      <div class="join-form">
        <div class="input-group">
          <label>Your Name</label>
          <input type="text" id="name-input" placeholder="Enter your name" maxlength="20" autocomplete="off">
        </div>
        <button class="btn btn-primary btn-sm" onclick="joinGame()" style="margin-bottom:0;">Join</button>
      </div>
      <div class="error-msg" id="join-error" style="margin-top:8px;"></div>
    </div>
    <div id="joined-section" class="hidden" style="text-align:center;">
      <p style="color:var(--success); margin-bottom:16px;">âœ“ You've joined the lobby</p>
      <button class="btn btn-success" id="start-btn" onclick="startGame()" disabled>
        Start Game (Need 3+ Players)
      </button>
    </div>
  </div>
  <div class="lobby-status" id="lobby-status">Waiting for players...</div>
</div>

<!-- GAME SCREEN -->
<div id="game-screen" class="screen">
  <div class="game-header">
    <div class="logo-title" style="font-size:1.3rem;">PRISMADICe</div>
    <div class="round-info" id="round-info">Round 1 / 13</div>
    <button class="abandon-btn" onclick="showAbandonConfirm()">Abandon Game</button>
  </div>
  <div class="turn-banner" id="turn-banner">Waiting...</div>

  <div class="game-layout">
    <div class="player-sidebar" id="player-sidebar"></div>

    <div class="game-main">
      <div class="dice-section">
        <div class="dice-row" id="dice-row"></div>
        <div class="roll-controls hidden" id="roll-controls">
          <button class="btn btn-accent btn-sm" id="roll-btn" onclick="rollDice()">Roll Dice</button>
          <span class="roll-count" id="roll-count">Roll 1 / 3</span>
        </div>
      </div>

      <div class="phase-indicator hidden" id="phase-indicator">
        <span class="phase-step" id="phase-roll">Roll</span>
        <span class="phase-arrow">â†’</span>
        <span class="phase-step" id="phase-score">Score</span>
        <span class="phase-arrow">â†’</span>
        <span class="phase-step" id="phase-color">Color Chart</span>
      </div>

      <div class="scoring-section" id="scoring-section">
        <div class="score-panel">
          <h3 id="scorecard-title">Scorecard</h3>
          <div id="upper-section">
            <div class="score-row" data-cat="ones"><span class="score-category">Ones</span><span class="score-value" id="sc-ones">â€”</span></div>
            <div class="score-row" data-cat="twos"><span class="score-category">Twos</span><span class="score-value" id="sc-twos">â€”</span></div>
            <div class="score-row" data-cat="threes"><span class="score-category">Threes</span><span class="score-value" id="sc-threes">â€”</span></div>
            <div class="score-row" data-cat="fours"><span class="score-category">Fours</span><span class="score-value" id="sc-fours">â€”</span></div>
            <div class="score-row" data-cat="fives"><span class="score-category">Fives</span><span class="score-value" id="sc-fives">â€”</span></div>
            <div class="score-row" data-cat="sixes"><span class="score-category">Sixes</span><span class="score-value" id="sc-sixes">â€”</span></div>
            <div class="score-row score-bonus-row"><span class="score-category">Upper Bonus</span><span class="score-value" id="sc-upper-bonus">â€”</span></div>
          </div>
          <div id="lower-section" style="margin-top:8px;">
            <div class="score-row" data-cat="twoPair"><span class="score-category">Two Pair</span><span class="score-value" id="sc-twoPair">â€”</span></div>
            <div class="score-row" data-cat="fullHouse"><span class="score-category">Full House</span><span class="score-value" id="sc-fullHouse">â€”</span></div>
            <div class="score-row" data-cat="odds"><span class="score-category">All Odds</span><span class="score-value" id="sc-odds">â€”</span></div>
            <div class="score-row" data-cat="evens"><span class="score-category">All Evens</span><span class="score-value" id="sc-evens">â€”</span></div>
            <div class="score-row" data-cat="low"><span class="score-category">Low (â‰¤11)</span><span class="score-value" id="sc-low">â€”</span></div>
            <div class="score-row" data-cat="high"><span class="score-category">High (â‰¥24)</span><span class="score-value" id="sc-high">â€”</span></div>
            <div class="score-row" data-cat="chance"><span class="score-category">Chance</span><span class="score-value" id="sc-chance">â€”</span></div>
          </div>
          <div class="score-row score-bonus-row" style="margin-top:8px;">
            <span class="score-category">TOTAL</span>
            <span class="score-value" id="sc-total" style="font-size:1rem; color:var(--gold);">0</span>
          </div>
        </div>

        <div class="color-chart-panel">
          <h3>Color Chart</h3>
          <div class="rainbow-info hidden" id="rainbow-info">
            <span id="rainbow-text">ðŸŒˆ 1 Rainbow â€” Cross off 1 matching die</span>
          </div>
          <div class="color-chart" id="color-chart"></div>
          <div style="margin-top:12px; text-align:center;" id="color-actions">
            <button class="btn btn-success btn-sm hidden" id="confirm-color-btn" onclick="confirmColorCrossoffs()">Confirm Crossoffs</button>
            <button class="btn btn-sm hidden" id="skip-color-btn" onclick="skipColorCrossoffs()" style="background:var(--bg-surface); color:var(--text-secondary); margin-left:8px;">Skip</button>
          </div>
        </div>
      </div>

      <div class="turn-actions hidden" id="turn-actions">
        <button class="btn btn-success" id="confirm-score-btn" onclick="confirmScore()" disabled>Confirm Score Selection</button>
      </div>
    </div>
  </div>
</div>

<!-- Abandon Confirm -->
<div class="overlay" id="abandon-confirm">
  <div class="overlay-card abandon fade-in">
    <h3>Abandon Game?</h3>
    <p>This will end the current game for all players. This cannot be undone.</p>
    <div class="confirm-buttons">
      <button class="btn btn-sm btn-cancel" onclick="hideAbandonConfirm()">Cancel</button>
      <button class="btn btn-sm btn-accent" onclick="abandonGame()">Abandon Game</button>
    </div>
  </div>
</div>

<!-- Game Over -->
<div class="overlay" id="game-over">
  <div class="overlay-card gameover fade-in">
    <h2>Game Over!</h2>
    <div class="final-scores" id="final-scores"></div>
    <button class="btn btn-primary" onclick="returnToLobby()">Return to Lobby</button>
  </div>
</div>

<!-- Firebase SDK â€” loaded at end of body so DOM is ready -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
// ==========================================
// FIREBASE
// ==========================================
const firebaseConfig = {
  apiKey: "AIzaSyDfmyncb46dDdxKZDmX1sq5GWypgNg1oZ0",
  authDomain: "prismadice-7866d.firebaseapp.com",
  databaseURL: "https://prismadice-7866d-default-rtdb.firebaseio.com",
  projectId: "prismadice-7866d",
  storageBucket: "prismadice-7866d.firebasestorage.app",
  messagingSenderId: "1066439057806",
  appId: "1:1066439057806:web:90600cfc17a2aeff0804df",
  measurementId: "G-TESHF91V0V"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const gameRef = db.ref('prismadice');

// ==========================================
// HELPERS
// ==========================================
function showEl(id) { document.getElementById(id).classList.remove('hidden'); }
function hideEl(id) { document.getElementById(id).classList.add('hidden'); }
function showOverlay(id) { document.getElementById(id).classList.add('visible'); }
function hideOverlay(id) { document.getElementById(id).classList.remove('visible'); }

// ==========================================
// STATE
// ==========================================
const COLORS = ['red', 'yellow', 'green', 'blue', 'purple'];
const CATEGORIES = ['ones','twos','threes','fours','fives','sixes','twoPair','fullHouse','odds','evens','low','high','chance'];

let myPlayerId = null;
let myName = null;
let gameState = null;
let viewingPlayer = null;
let selectedCategory = null;
let selectedCrossoffs = [];

function generateId() {
  return 'p_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
}

// ==========================================
// SCREENS
// ==========================================
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

// ==========================================
// PASSWORD
// ==========================================
document.getElementById('password-input').addEventListener('keypress', (e) => {
  if (e.key === 'Enter') checkPassword();
});

function checkPassword() {
  if (document.getElementById('password-input').value === 'markeegames') {
    showScreen('lobby-screen');
    initLobby();
  } else {
    document.getElementById('password-error').textContent = 'Incorrect password.';
  }
}

// ==========================================
// LOBBY
// ==========================================
function initLobby() {
  myPlayerId = generateId();

  gameRef.on('value', (snap) => {
    gameState = snap.val() || {};
    if (gameState.status === 'playing') {
      showScreen('game-screen');
      renderGame();
    } else {
      renderLobby();
    }
  });

  gameRef.child('players').child(myPlayerId).onDisconnect().remove();

  document.getElementById('name-input').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') joinGame();
  });
}

function renderLobby() {
  const players = gameState.players || {};
  const playerList = Object.entries(players);
  const slotsDiv = document.getElementById('player-slots');

  let html = '';
  for (let i = 0; i < 6; i++) {
    if (i < playerList.length) {
      const [pid, pdata] = playerList[i];
      const isMe = pid === myPlayerId;
      html += `<div class="player-slot ${isMe ? 'you' : 'occupied'}">
        <span class="slot-number">${i + 1}</span>
        <span class="slot-name">${pdata.name}</span>
        ${isMe ? '<span class="slot-you-badge">YOU</span>' : ''}
      </div>`;
    } else {
      html += `<div class="player-slot">
        <span class="slot-number">${i + 1}</span>
        <span class="slot-name slot-empty">Waiting for player...</span>
      </div>`;
    }
  }
  slotsDiv.innerHTML = html;

  const count = playerList.length;
  document.getElementById('lobby-status').textContent =
    count < 3 ? `${count}/6 players â€” need at least 3 to start` : `${count}/6 players â€” ready to start!`;

  const startBtn = document.getElementById('start-btn');
  if (startBtn) {
    startBtn.disabled = count < 3;
    startBtn.textContent = count < 3 ? `Start Game (Need ${3 - count} more)` : 'Start Game!';
  }

  if (players[myPlayerId]) {
    hideEl('join-section');
    showEl('joined-section');
  }

  if (count >= 6 && !players[myPlayerId]) {
    document.getElementById('join-section').innerHTML = '<p style="color:var(--red);">Lobby is full (6/6 players)</p>';
  }
}

function joinGame() {
  const name = document.getElementById('name-input').value.trim();
  const errorEl = document.getElementById('join-error');

  if (!name) { errorEl.textContent = 'Please enter a name.'; return; }
  if (name.length > 20) { errorEl.textContent = 'Name must be 20 characters or less.'; return; }

  const players = gameState.players || {};
  if (Object.values(players).some(p => p.name.toLowerCase() === name.toLowerCase())) {
    errorEl.textContent = 'That name is already taken.'; return;
  }
  if (Object.keys(players).length >= 6) { errorEl.textContent = 'Lobby is full.'; return; }
  if (gameState.status === 'playing') { errorEl.textContent = 'A game is already in progress.'; return; }

  myName = name;
  errorEl.textContent = '';
  gameRef.child('players').child(myPlayerId).set({ name, connected: true });
}

function startGame() {
  const players = gameState.players || {};
  const playerIds = Object.keys(players);
  if (playerIds.length < 3) return;

  const shuffled = [...playerIds].sort(() => Math.random() - 0.5);

  const initState = {
    status: 'playing',
    players: {},
    turnOrder: shuffled,
    currentTurnIndex: 0,
    currentRound: 1,
    turn: {
      phase: 'rolling',
      rollNumber: 0,
      dice: {
        red: { value: 0, locked: false },
        yellow: { value: 0, locked: false },
        green: { value: 0, locked: false },
        blue: { value: 0, locked: false },
        purple: { value: 0, locked: false },
      },
      rainbow: { value: 0 },
      selectedCategory: null,
      scoreConfirmed: false,
      colorConfirmed: false
    },
    scores: {}
  };

  shuffled.forEach((pid, idx) => {
    initState.players[pid] = { name: players[pid].name, order: idx };
    initState.scores[pid] = {
      dice: {},
      colorChart: {
        red: [false,false,false,false,false,false],
        yellow: [false,false,false,false,false,false],
        green: [false,false,false,false,false,false],
        blue: [false,false,false,false,false,false],
        purple: [false,false,false,false,false,false]
      }
    };
    CATEGORIES.forEach(cat => { initState.scores[pid].dice[cat] = null; });
  });

  gameRef.set(initState);
}

// ==========================================
// GAME RENDERING
// ==========================================
function isMyTurn() {
  return gameState?.turnOrder?.[gameState.currentTurnIndex] === myPlayerId;
}

function currentPlayerId() {
  return gameState?.turnOrder?.[gameState.currentTurnIndex] || null;
}

function renderGame() {
  if (!gameState || gameState.status !== 'playing') return;
  if (!myName && gameState.players[myPlayerId]) myName = gameState.players[myPlayerId].name;
  if (!viewingPlayer) viewingPlayer = myPlayerId;

  renderHeader();
  renderPlayerSidebar();
  renderDice();
  renderScorecard();
  renderColorChart();
  renderPhaseIndicator();
  renderControls();

  if (gameState.currentRound > 13) showGameOver();
}

function renderHeader() {
  const round = Math.min(gameState.currentRound, 13);
  document.getElementById('round-info').textContent = `Round ${round} / 13`;

  const cpid = currentPlayerId();
  const cname = gameState.players[cpid]?.name || '???';
  const bannerEl = document.getElementById('turn-banner');

  if (isMyTurn()) {
    bannerEl.className = 'turn-banner your-turn';
    const phase = gameState.turn?.phase || 'rolling';
    if (phase === 'rolling') {
      bannerEl.textContent = gameState.turn.rollNumber === 0
        ? "Your turn! Roll the dice!"
        : "Lock dice and reroll, or keep your roll.";
    } else if (phase === 'scoring') {
      bannerEl.textContent = 'Select a scoring category.';
    } else if (phase === 'color') {
      bannerEl.textContent = 'Cross off on the color chart (optional).';
    }
  } else {
    bannerEl.className = 'turn-banner';
    bannerEl.textContent = `${cname}'s turn`;
  }
}

function renderPlayerSidebar() {
  const sidebar = document.getElementById('player-sidebar');
  let html = '<div class="sidebar-title">Players</div>';

  gameState.turnOrder.forEach((pid, idx) => {
    const p = gameState.players[pid];
    if (!p) return;
    html += `<div class="sidebar-player ${idx === gameState.currentTurnIndex ? 'active-turn' : ''} ${pid === viewingPlayer ? 'viewing' : ''}"
      onclick="viewPlayerScorecard('${pid}')">
      <span class="sidebar-player-name">${p.name}${pid === myPlayerId ? ' (you)' : ''}</span>
      <span class="sidebar-player-score">${calculateTotalScore(pid)}</span>
    </div>`;
  });

  sidebar.innerHTML = html;
}

function viewPlayerScorecard(pid) {
  viewingPlayer = pid;
  renderScorecard();
  renderColorChart();
  renderPlayerSidebar();
}

function renderDice() {
  const turn = gameState.turn;
  if (!turn) return;

  const diceRow = document.getElementById('dice-row');
  let html = '';

  COLORS.forEach(color => {
    const d = turn.dice[color];
    const canClick = isMyTurn() && turn.phase === 'rolling' && turn.rollNumber > 0 && turn.rollNumber < 3;
    html += `<div class="die-container">
      <div class="die ${color} ${d.locked ? 'locked' : ''} ${canClick ? 'clickable' : ''}"
           ${canClick ? `onclick="toggleLock('${color}')"` : ''}>
        ${d.value > 0 ? d.value : '?'}
      </div>
      <span class="die-label">${color}</span>
    </div>`;
  });

  html += `<div class="die-container">
    <div class="die rainbow">${turn.rainbow.value > 0 ? 'ðŸŒˆ'.repeat(turn.rainbow.value) : '?'}</div>
    <span class="die-label">Rainbow</span>
  </div>`;

  diceRow.innerHTML = html;
}

function renderPhaseIndicator() {
  const turn = gameState.turn;
  if (!turn || turn.rollNumber === 0) { hideEl('phase-indicator'); return; }

  showEl('phase-indicator');
  const phase = turn.phase;
  document.getElementById('phase-roll').className = 'phase-step' + (phase === 'rolling' ? ' active' : ' completed');
  document.getElementById('phase-score').className = 'phase-step' + (phase === 'scoring' ? ' active' : (phase === 'color' ? ' completed' : ''));
  document.getElementById('phase-color').className = 'phase-step' + (phase === 'color' ? ' active' : '');
}

function renderScorecard() {
  const pid = viewingPlayer;
  if (!pid || !gameState.scores[pid]) return;

  const scores = gameState.scores[pid].dice;
  const isMe = pid === myPlayerId;
  const turn = gameState.turn;
  const inScoringPhase = isMe && isMyTurn() && turn?.phase === 'scoring';

  document.getElementById('scorecard-title').textContent = isMe ? 'Your Scorecard' : `${gameState.players[pid]?.name}'s Scorecard`;

  const diceVals = isMyTurn() && turn?.rollNumber > 0 ? COLORS.map(c => turn.dice[c].value) : null;

  CATEGORIES.forEach(cat => {
    const row = document.querySelector(`.score-row[data-cat="${cat}"]`);
    const valueEl = document.getElementById(`sc-${cat}`);
    if (!row || !valueEl) return;

    const scored = scores[cat];
    if (scored !== null && scored !== undefined) {
      valueEl.textContent = scored;
      valueEl.className = `score-value ${scored === 0 ? 'zero' : 'scored'}`;
      row.className = 'score-row used';
      row.onclick = null;
    } else if (inScoringPhase && diceVals) {
      valueEl.textContent = calculateCategoryScore(cat, diceVals);
      valueEl.className = 'score-value potential';
      row.className = `score-row clickable ${selectedCategory === cat ? 'selected' : ''}`;
      row.onclick = () => selectCategory(cat);
    } else {
      valueEl.textContent = 'â€”';
      valueEl.className = 'score-value';
      row.className = 'score-row';
      row.onclick = null;
    }
  });

  const upperSum = ['ones','twos','threes','fours','fives','sixes']
    .reduce((sum, cat) => sum + (scores[cat] || 0), 0);
  const bonusEl = document.getElementById('sc-upper-bonus');
  if (upperSum >= 63) { bonusEl.textContent = '+35'; bonusEl.style.color = 'var(--gold)'; }
  else if (upperSum >= 55) { bonusEl.textContent = '+20'; bonusEl.style.color = 'var(--green)'; }
  else { bonusEl.textContent = `(${upperSum}/55)`; bonusEl.style.color = 'var(--text-muted)'; }

  document.getElementById('sc-total').textContent = calculateTotalScore(pid);
}

function renderColorChart() {
  const pid = viewingPlayer;
  if (!pid || !gameState.scores[pid]) return;

  const chart = gameState.scores[pid].colorChart;
  const isMe = pid === myPlayerId;
  const turn = gameState.turn;
  const inColorPhase = isMe && isMyTurn() && turn?.phase === 'color';
  const rainbowVal = turn?.rainbow?.value || 0;

  if (inColorPhase && rainbowVal > 0) {
    showEl('rainbow-info');
    const txt = document.getElementById('rainbow-text');
    if (rainbowVal === 1) txt.textContent = 'ðŸŒˆ 1 Rainbow â€” Cross off 1 matching die';
    else if (rainbowVal === 2) txt.textContent = 'ðŸŒˆðŸŒˆ 2 Rainbows â€” Cross off 2 dice of the same number (or downgrade)';
    else txt.textContent = 'ðŸŒˆðŸŒˆðŸŒˆ 3 Rainbows â€” Cross off 3 dice of different numbers (or downgrade)';
  } else {
    hideEl('rainbow-info');
  }

  const chartDiv = document.getElementById('color-chart');
  let html = '<div class="chart-header-row">';
  for (let n = 1; n <= 6; n++) html += `<div class="chart-header-cell">${n}</div>`;
  html += '<div style="width:40px;"></div></div>';

  COLORS.forEach(color => {
    html += `<div class="chart-row"><div class="chart-row-label" style="color:var(--${color})">${color}</div>`;
    for (let n = 0; n < 6; n++) {
      const crossed = chart[color][n];
      const isSelected = selectedCrossoffs.some(c => c.color === color && c.number === n);
      let cls = 'chart-cell';
      if (crossed) cls += ' crossed';
      else if (isSelected) cls += ' empty selected-cross';
      else if (inColorPhase && canSelectCrossoff(color, n)) cls += ' empty clickable';
      else cls += ' empty';
      const click = inColorPhase && !crossed ? `onclick="toggleCrossoff('${color}', ${n})"` : '';
      html += `<div class="${cls}" ${click}>${crossed ? '' : (n + 1)}</div>`;
    }
    html += `<div class="chart-row-score">${calculateRowScore(chart[color]) || ''}</div></div>`;
  });

  html += '<div class="chart-column-scores">';
  for (let n = 0; n < 6; n++) {
    html += `<div class="chart-col-score">${COLORS.every(c => chart[c][n]) ? '25' : ''}</div>`;
  }
  html += '<div style="width:40px;"></div></div>';
  chartDiv.innerHTML = html;

  if (inColorPhase) {
    showEl('skip-color-btn');
    if (selectedCrossoffs.length > 0) showEl('confirm-color-btn'); else hideEl('confirm-color-btn');
  } else {
    hideEl('confirm-color-btn');
    hideEl('skip-color-btn');
  }
}

function renderControls() {
  const turn = gameState.turn;
  if (!turn) return;

  const oldKeep = document.getElementById('keep-btn');
  if (oldKeep) oldKeep.remove();

  if (isMyTurn()) {
    if (turn.phase === 'rolling') {
      showEl('roll-controls');
      hideEl('turn-actions');
      const rollBtn = document.getElementById('roll-btn');
      const rollCount = document.getElementById('roll-count');

      if (turn.rollNumber === 0) {
        rollBtn.textContent = 'Roll Dice!';
        rollBtn.disabled = false;
        rollCount.textContent = 'Roll 1 / 3';
      } else if (turn.rollNumber < 3) {
        rollBtn.textContent = 'Reroll';
        rollBtn.disabled = false;
        rollCount.textContent = `Roll ${turn.rollNumber} / 3`;
        if (!document.getElementById('keep-btn')) {
          rollBtn.insertAdjacentHTML('afterend',
            '<button class="btn btn-success btn-sm" id="keep-btn" onclick="keepDice()" style="margin-left:8px;">Keep & Score</button>');
        }
      } else {
        hideEl('roll-controls');
      }
    } else if (turn.phase === 'scoring') {
      hideEl('roll-controls');
      showEl('turn-actions');
      document.getElementById('confirm-score-btn').disabled = !selectedCategory;
    } else {
      hideEl('roll-controls');
      hideEl('turn-actions');
    }
  } else {
    hideEl('roll-controls');
    hideEl('turn-actions');
  }
}

// ==========================================
// DICE
// ==========================================
function rollDie() { return Math.floor(Math.random() * 6) + 1; }

function rollRainbow() {
  const r = Math.random();
  if (r < 0.5) return 1;
  if (r < 5/6) return 2;
  return 3;
}

function rollDice() {
  if (!isMyTurn()) return;
  const turn = gameState.turn;
  const updates = {};
  const isFirst = turn.rollNumber === 0;

  COLORS.forEach(color => {
    if (isFirst || !turn.dice[color].locked) {
      updates[`turn/dice/${color}/value`] = rollDie();
      updates[`turn/dice/${color}/locked`] = false;
    }
  });

  updates['turn/rainbow/value'] = rollRainbow();
  updates['turn/rollNumber'] = turn.rollNumber + 1;
  if (turn.rollNumber + 1 >= 3) updates['turn/phase'] = 'scoring';

  gameRef.update(updates);

  setTimeout(() => {
    document.querySelectorAll('.die').forEach(d => {
      d.classList.add('rolling');
      setTimeout(() => d.classList.remove('rolling'), 400);
    });
  }, 50);
}

function toggleLock(color) {
  if (!isMyTurn()) return;
  const turn = gameState.turn;
  if (turn.phase !== 'rolling' || turn.rollNumber === 0) return;
  gameRef.child(`turn/dice/${color}/locked`).set(!turn.dice[color].locked);
}

function keepDice() {
  if (!isMyTurn()) return;
  gameRef.child('turn/phase').set('scoring');
}

// ==========================================
// SCORING
// ==========================================
function calculateCategoryScore(cat, diceVals) {
  const sum = diceVals.reduce((a, b) => a + b, 0);
  const counts = {};
  diceVals.forEach(v => { counts[v] = (counts[v] || 0) + 1; });

  switch (cat) {
    case 'ones': return diceVals.filter(v => v === 1).reduce((a,b) => a+b, 0);
    case 'twos': return diceVals.filter(v => v === 2).reduce((a,b) => a+b, 0);
    case 'threes': return diceVals.filter(v => v === 3).reduce((a,b) => a+b, 0);
    case 'fours': return diceVals.filter(v => v === 4).reduce((a,b) => a+b, 0);
    case 'fives': return diceVals.filter(v => v === 5).reduce((a,b) => a+b, 0);
    case 'sixes': return diceVals.filter(v => v === 6).reduce((a,b) => a+b, 0);
    case 'twoPair': {
      const pairs = Object.keys(counts).filter(k => counts[k] >= 2);
      return pairs.length >= 2 ? sum + (sum < 18 ? 10 : 0) : 0;
    }
    case 'fullHouse': {
      const entries = Object.entries(counts);
      let valid = false;
      for (let i = 0; i < entries.length; i++) {
        if (entries[i][1] >= 3) {
          for (let j = 0; j < entries.length; j++) {
            if (i !== j && entries[j][1] >= 2) { valid = true; break; }
          }
        }
      }
      return valid ? sum + (sum < 18 ? 10 : 0) : 0;
    }
    case 'odds': {
      const oddSum = diceVals.filter(v => v % 2 === 1).reduce((a,b) => a+b, 0);
      return oddSum + (diceVals.every(v => v % 2 === 1) ? 10 : 0);
    }
    case 'evens': {
      const evenSum = diceVals.filter(v => v % 2 === 0).reduce((a,b) => a+b, 0);
      return evenSum + (diceVals.every(v => v % 2 === 0) ? 10 : 0);
    }
    case 'low': return sum <= 11 ? 25 : 0;
    case 'high': return sum >= 24 ? 25 : 0;
    case 'chance': return sum;
    default: return 0;
  }
}

function selectCategory(cat) {
  if (!isMyTurn() || gameState.turn?.phase !== 'scoring') return;
  if (gameState.scores[myPlayerId].dice[cat] !== null) return;
  selectedCategory = (selectedCategory === cat) ? null : cat;
  renderScorecard();
  renderControls();
}

function confirmScore() {
  if (!isMyTurn() || !selectedCategory) return;
  const diceVals = COLORS.map(c => gameState.turn.dice[c].value);
  const score = calculateCategoryScore(selectedCategory, diceVals);

  gameRef.update({
    [`scores/${myPlayerId}/dice/${selectedCategory}`]: score,
    'turn/phase': 'color',
    'turn/scoreConfirmed': true,
    'turn/selectedCategory': selectedCategory
  });
  selectedCategory = null;
}

// ==========================================
// COLOR CHART
// ==========================================
function canSelectCrossoff(color, number) {
  if (!isMyTurn() || gameState.turn?.phase !== 'color') return false;
  if (gameState.scores[myPlayerId].colorChart[color][number]) return false;
  return gameState.turn.dice[color].value === number + 1;
}

function toggleCrossoff(color, number) {
  if (!isMyTurn() || gameState.turn?.phase !== 'color') return;
  if (gameState.scores[myPlayerId].colorChart[color][number]) return;

  const idx = selectedCrossoffs.findIndex(c => c.color === color && c.number === number);
  if (idx >= 0) {
    selectedCrossoffs.splice(idx, 1);
  } else {
    if (!validateCrossoffSelection(color, number)) return;
    selectedCrossoffs.push({ color, number });
  }
  renderColorChart();
}

function validateCrossoffSelection(newColor, newNumber) {
  const turn = gameState.turn;
  const rainbowVal = turn.rainbow.value;
  if (turn.dice[newColor].value !== newNumber + 1) return false;

  const proposed = [...selectedCrossoffs, { color: newColor, number: newNumber }];
  if (proposed.length > rainbowVal) return false;

  if (rainbowVal === 1) return proposed.length <= 1;
  if (rainbowVal === 2) {
    if (proposed.length <= 1) return true;
    return proposed[0].number === proposed[1].number;
  }
  if (rainbowVal === 3) {
    if (proposed.length <= 1) return true;
    const numbers = proposed.map(c => c.number);
    if (new Set(numbers).size === proposed.length) return true;
    if (proposed.length === 2) return proposed[0].number === proposed[1].number;
    return false;
  }
  return false;
}

function confirmColorCrossoffs() {
  if (!isMyTurn() || selectedCrossoffs.length === 0) return;
  const updates = {};
  selectedCrossoffs.forEach(({ color, number }) => {
    updates[`scores/${myPlayerId}/colorChart/${color}/${number}`] = true;
  });
  gameRef.update(updates);
  selectedCrossoffs = [];
  endTurn();
}

function skipColorCrossoffs() {
  if (!isMyTurn()) return;
  selectedCrossoffs = [];
  endTurn();
}

// ==========================================
// TURNS
// ==========================================
function endTurn() {
  let nextIndex = gameState.currentTurnIndex + 1;
  let nextRound = gameState.currentRound;
  if (nextIndex >= gameState.turnOrder.length) { nextIndex = 0; nextRound++; }

  gameRef.update({
    currentTurnIndex: nextIndex,
    currentRound: nextRound,
    turn: {
      phase: 'rolling', rollNumber: 0,
      dice: {
        red: { value: 0, locked: false }, yellow: { value: 0, locked: false },
        green: { value: 0, locked: false }, blue: { value: 0, locked: false },
        purple: { value: 0, locked: false },
      },
      rainbow: { value: 0 },
      selectedCategory: null, scoreConfirmed: false, colorConfirmed: false
    }
  });
  viewingPlayer = myPlayerId;
}

// ==========================================
// SCORE CALC
// ==========================================
function calculateRowScore(row) {
  if (row.every(v => v)) return 30;
  for (let s = 0; s <= 1; s++) { if (row.slice(s, s + 5).every(v => v)) return 25; }
  for (let s = 0; s <= 2; s++) { if (row.slice(s, s + 4).every(v => v)) return 20; }
  return 0;
}

function calculateTotalScore(pid) {
  if (!gameState.scores[pid]) return 0;
  const scores = gameState.scores[pid].dice;
  const chart = gameState.scores[pid].colorChart;

  let total = 0;
  CATEGORIES.forEach(cat => { if (scores[cat] != null) total += scores[cat]; });

  const upperSum = ['ones','twos','threes','fours','fives','sixes']
    .reduce((sum, cat) => sum + (scores[cat] || 0), 0);
  if (upperSum >= 63) total += 35;
  else if (upperSum >= 55) total += 20;

  COLORS.forEach(color => { total += calculateRowScore(chart[color]); });
  for (let n = 0; n < 6; n++) {
    if (COLORS.every(c => chart[c][n])) total += 25;
  }
  return total;
}

// ==========================================
// GAME OVER & ABANDON
// ==========================================
function showGameOver() {
  showOverlay('game-over');
  const results = gameState.turnOrder.map(pid => ({
    name: gameState.players[pid]?.name || '???',
    score: calculateTotalScore(pid), pid
  })).sort((a, b) => b.score - a.score);

  const top = results[0].score;
  document.getElementById('final-scores').innerHTML = results.map((r, i) => `
    <div class="final-score-row ${r.score === top ? 'winner' : ''}">
      <span class="final-score-name">${i === 0 ? 'ðŸ‘‘ ' : ''}${r.name}${r.pid === myPlayerId ? ' (you)' : ''}</span>
      <span class="final-score-pts">${r.score} pts</span>
    </div>
  `).join('');
}

function showAbandonConfirm() { showOverlay('abandon-confirm'); }
function hideAbandonConfirm() { hideOverlay('abandon-confirm'); }
function abandonGame() { hideAbandonConfirm(); returnToLobby(); }

function returnToLobby() {
  gameRef.set({ status: 'lobby', players: {} });
  hideOverlay('game-over');
  showScreen('lobby-screen');
  showEl('join-section');
  hideEl('joined-section');
  viewingPlayer = null;
  selectedCategory = null;
  selectedCrossoffs = [];
}
</script>

</body>
</html>